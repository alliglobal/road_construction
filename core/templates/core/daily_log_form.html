{% extends "core/base.html" %}
{% block content %}

<div class="container">

<h4 class="mb-3">
    üìò Ghi nh·∫≠t k√Ω thi c√¥ng ‚Äì {{ log_date|date:"d/m/Y" }}
</h4>

<form method="post">
{% csrf_token %}

<div class="row mb-3">
    <div class="col-md-6">
        <label class="form-label">C√¥ng vi·ªác</label>
        <select id="work_item_select"
                name="work_item_id"
                class="form-select"
                required>
            <option value="">-- Ch·ªçn c√¥ng vi·ªác --</option>
            {% for wi in work_items %}
            <option value="{{ wi.id }}">
                {{ wi.index_code }} ‚Äì {{ wi.name }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">Kh·ªëi l∆∞·ª£ng th·ª±c hi·ªán</label>
        <input type="number"
               step="0.01"
               min="0"
               id="quantity_input"
               name="quantity"
               class="form-control"
               required>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-light">
        üîß V·∫≠t t∆∞ ti√™u hao (t·ª± ƒë·ªông)
    </div>

    <div class="card-body p-0">
        <table class="table table-bordered mb-0" id="materialTable">
            <thead>
                <tr class="text-center">
                    <th>V·∫≠t t∆∞</th>
                    <th>ƒê·ªãnh m·ª©c</th>
                    <th>H·ªá s·ªë</th>
                    <th>Ti√™u hao</th>
                    <th>ƒê∆°n v·ªã</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        Ch·ªçn c√¥ng vi·ªác v√† nh·∫≠p kh·ªëi l∆∞·ª£ng
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<button class="btn btn-primary">
    üíæ L∆∞u nh·∫≠t k√Ω
</button>

</form>

<hr class="my-4">

<h5 class="mb-3">üìã Nh·∫≠t k√Ω ƒë√£ ghi trong ng√†y</h5>

{% if items %}
<table class="table table-bordered table-sm align-middle">
    <thead class="table-light text-center">
        <tr>
            <th style="width: 50px;">#</th>
            <th>C√¥ng vi·ªác</th>
            <th style="width: 150px;">Kh·ªëi l∆∞·ª£ng</th>
            <th style="width:120px">Thao t√°c</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr>
            <td class="text-center">{{ forloop.counter }}</td>
            <td>
                {{ item.work_item.index_code }} ‚Äì {{ item.work_item.name }}
            </td>
            <td class="text-end fw-bold">
                {{ item.quantity_done }}
            </td>
            <td class="text-center">
    <a href="{% url 'daily_log_item_edit' item.id %}"
       class="btn btn-sm btn-outline-primary">
        ‚úèÔ∏è
    </a>

    <a href="{% url 'daily_log_item_delete' item.id %}"
       class="btn btn-sm btn-outline-danger"
       onclick="return confirm('Xo√° d√≤ng n√†y?')">
        üóë
    </a>
</td>

        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="alert alert-secondary">
    Ch∆∞a c√≥ c√¥ng vi·ªác n√†o ƒë∆∞·ª£c ghi trong ng√†y n√†y.
</div>
{% endif %}



</div>

<script>
let materials = [];

const workSelect = document.getElementById('work_item_select');
const qtyInput = document.getElementById('quantity_input');
const tableBody = document.querySelector('#materialTable tbody');

workSelect.addEventListener('change', () => {
    const workItemId = workSelect.value;
    tableBody.innerHTML = '';

    if (!workItemId) return;

    fetch(`/api/work-item/${workItemId}/materials/`)
        .then(res => res.json())
        .then(data => {
            materials = data;
            renderMaterials();
        });
});

qtyInput.addEventListener('input', renderMaterials);

function renderMaterials() {
    tableBody.innerHTML = '';

    const qty = parseFloat(qtyInput.value || 0);

    if (materials.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    C√¥ng vi·ªác ch∆∞a c√≥ d·ª± tr√π v·∫≠t t∆∞
                </td>
            </tr>`;
        return;
    }

    materials.forEach(m => {
        const used = qty * m.norm * m.factor;

        tableBody.innerHTML += `
        <tr>
            <td>${m.material}</td>
            <td class="text-end">${m.norm}</td>
            <td class="text-end">${m.factor}</td>
            <td class="text-end fw-bold">${used.toFixed(2)}</td>
            <td class="text-center">${m.unit}</td>
        </tr>`;
    });
}
</script>

{% endblock %}
