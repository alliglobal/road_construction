{% extends "core/base.html" %}
{% block content %}

<h4>
    üß± D·ª± tr√π v·∫≠t t∆∞ ‚Äì {{ work_item.index_code }} {{ work_item.name }}
</h4>

<p class="text-muted">
    Kh·ªëi l∆∞·ª£ng c√¥ng vi·ªác:
    <strong id="work-quantity">
        {{ work_item.quantity|default:0 }}
    </strong>
</p>

<div class="card mb-4">
    <div class="card-header bg-info text-white">
        ‚ûï Nh·∫≠p v·∫≠t t∆∞
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            <div class="row">

                <div class="col-md-3">
                    <label>V·∫≠t t∆∞</label>
                    <select name="material" class="form-control" required>
                        {% for m in all_materials %}
                            <option value="{{ m.id }}">
                                {{ m.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label>Kh·ªëi l∆∞·ª£ng v·∫≠t t∆∞</label>
                    <input type="number" step="0.001"
                           name="quantity"
                           id="quantity"
                           class="form-control"
                           required>
                </div>

                <div class="col-md-2">
                    <label>H·ªá s·ªë</label>
                    <input type="number" step="0.01"
                           name="factor"
                           id="factor"
                           value="1"
                           class="form-control">
                </div>

                <div class="col-md-2">
                    <label>ƒê·ªãnh m·ª©c</label>
                    <input type="number"
                           id="norm"
                           class="form-control"
                           readonly>
                </div>

                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100">
                        L∆∞u
                    </button>
                </div>

            </div>
        </form>
    </div>
</div>

<!-- ===== B·∫¢NG ƒê√É NH·∫¨P ===== -->
<table class="table table-bordered table-sm">
    <thead class="table-light">
        <tr>
            <th>#</th>
            <th>V·∫≠t t∆∞</th>
            <th>ƒê∆°n v·ªã</th>
            <th>Kh·ªëi l∆∞·ª£ng</th>
            <th>H·ªá s·ªë</th>
            <th>ƒê·ªãnh m·ª©c</th>
        </tr>
    </thead>
    <tbody>
        {% for m in materials %}
        <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ m.material.name }}</td>
            <td>{{ m.material.unit }}</td>

            <td class="text-end">{{ m.quantity }}</td>
            <td>{{ m.factor }}</td>
            <td class="text-end">
                {{ m.norm|floatformat:4 }}
            </td>
            <!-- XO√Å S·ª¨A -->
            <td>
                <a href="{% url 'edit_work_item_material' m.id %}"
                   class="btn btn-sm btn-warning">S·ª≠a</a>

                <form method="post"
                      action="{% url 'delete_work_item_material' m.id %}"
                      style="display:inline;">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-danger"
                            onclick="return confirm('Xo√° v·∫≠t t∆∞ n√†y?')">
                        Xo√°
                    </button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6"
                class="text-center text-muted">
                Ch∆∞a c√≥ v·∫≠t t∆∞
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<a href="{% url 'work_items' work_item.project.id %}"
   class="btn btn-secondary btn-sm">
    ‚Üê Quay l·∫°i
</a>

<!-- ===== JS T·ª∞ T√çNH ƒê·ªäNH M·ª®C ===== -->
<script>
(function () {
    const workQty = parseFloat(
        document.getElementById('work-quantity').innerText
    ) || 0;

    const qtyInput = document.getElementById('quantity');
    const factorInput = document.getElementById('factor');
    const normInput = document.getElementById('norm');

    function calculateNorm() {
        const qty = parseFloat(qtyInput.value) || 0;
        const factor = parseFloat(factorInput.value) || 1;

        if (workQty > 0) {
            const norm = qty / workQty / factor;
            normInput.value = norm.toFixed(4);
        } else {
            normInput.value = 0;
        }
    }

    qtyInput.addEventListener('input', calculateNorm);
    factorInput.addEventListener('input', calculateNorm);
})();
</script>

{% endblock %}
